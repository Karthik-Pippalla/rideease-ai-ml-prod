name: Nightly Offline Eval & Drift

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  offline-eval:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install deps
        run: |
          cd functions
          npm i
      - name: Run offline eval stub
        run: |
          node -e "const { runOfflineEval } = require('./functions/recommender/eval/offlineEval'); const report = runOfflineEval({ events: [], itemCatalog: [], itemToGeo: {}, reportDir: 'functions/reports'}); console.log(JSON.stringify(report));"
      - name: Upload reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: offline-eval-reports
          path: functions/reports
  drift-monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install deps
        run: |
          cd functions
          npm i
      - name: Run drift monitor stub
        run: |
          node -e "const { runDriftMonitor } = require('./functions/scripts/driftMonitor'); runDriftMonitor({ baselineEvents: [], currentEvents: [], outDir: 'functions/reports'});"
      - name: Upload drift artifact
        uses: actions/upload-artifact@v4
        with:
          name: drift-reports
          path: functions/reports

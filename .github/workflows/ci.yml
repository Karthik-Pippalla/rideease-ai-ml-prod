name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install deps
        run: npm --prefix functions install
      - name: Run unit tests
        run: npx --prefix functions jest --coverage --coverageThreshold='{"global":{"branches":70,"functions":70,"lines":70,"statements":70}}'
      - name: Lint (basic)
        run: npx --prefix functions eslint . || echo 'eslint not configured'
      - name: Build docker image
        run: |
          echo 'FROM node:22-alpine\nWORKDIR /app\nCOPY functions/package*.json ./\nRUN npm install --only=prod\nCOPY functions ./functions\nCMD ["node","functions/pipeline/eval_online.js"]' > Dockerfile
          docker build -t rideease-pipeline:latest .
      - name: Push to GHCR
        if: github.ref == 'refs/heads/main'
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker tag rideease-pipeline:latest ghcr.io/${{ github.repository_owner }}/rideease-pipeline:latest
          docker push ghcr.io/${{ github.repository_owner }}/rideease-pipeline:latest
  deploy:
    needs: build-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy placeholder (Cloud Run)
        env:
          GOOGLE_PROJECT: ${{ secrets.GCP_PROJECT }}
          GOOGLE_REGION: us-east1
        run: echo 'Add gcloud deploy step here'
